<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <title>æŒ¡æ¿å°„æ‰‹</title>
    <!-- ç§»é™¤å¤–éƒ¨CDNï¼Œä½¿ç”¨æœ¬åœ°èµ„æº -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
            .text-glow { text-shadow: 0 0 10px rgba(108, 92, 231, 0.8); }
            .bg-game {
                background: radial-gradient(circle at center, #1A1A2E 0%, #16213E 100%);
            }
            .scrollbar-hidden::-webkit-scrollbar { display: none; }
            .pixel-border {
                box-shadow: 0 0 0 2px #000,
                            0 0 0 5px #6C5CE7;
            }
            .game-container { perspective: 1000px; }
            .game-canvas {
                transform: rotateX(2deg);
                transition: transform 0.5s ease;
            }
            .game-canvas:hover {
                transform: rotateX(2deg) scale(1.01);
            }
            .character-option.selected {
                border-color: white;
                background-color: rgba(255,255,255,0.2);
            }
            .mode-option.selected {
                border-color: white;
                background-color: rgba(108, 92, 231, 0.3);
            }
            .fade-out { opacity: 0; transition: opacity 0.5s ease-out; }
            .round-transition {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 6rem;
                font-weight: bold;
                color: rgba(108, 92, 231, 0.7);
                z-index: 20;
                opacity: 0;
                pointer-events: none;
            }
            .powerup-indicator {
                position: absolute;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
                opacity: 0;
                transform: translateY(0);
                transition: opacity 0.3s ease, transform 0.5s ease;
                z-index: 15;
            }
            .stats-row {
                transition: background-color 0.2s ease;
            }
            .stats-row:hover {
                background-color: rgba(108, 92, 231, 0.1);
            }
            .shield-effect {
                position: absolute;
                border-radius: 50%;
                box-shadow: 0 0 15px 5px rgba(0, 210, 211, 0.6);
                pointer-events: none;
                z-index: 10;
                animation: shield-pulse 1.5s infinite;
            }
            @keyframes shield-pulse {
                0% { transform: scale(1); opacity: 0.7; }
                50% { transform: scale(1.05); opacity: 1; }
                100% { transform: scale(1); opacity: 0.7; }
            }
            .critical-indicator {
                position: absolute;
                color: #FFD700;
                font-size: 14px;
                font-weight: bold;
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
                opacity: 0;
                z-index: 10;
            }
            .bullet-effect {
                position: absolute;
                pointer-events: none;
                z-index: 10;
            }
        }
    </style>
    
    <!-- æœ¬åœ°Tailwind CSSæ›¿ä»£æ ·å¼ -->
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', sans-serif;
            color: #F5F6FA;
            background-color: #1A1A2E;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 7xl;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* å¸ƒå±€ç±» */
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        
        .grid-cols-6 {
            grid-template-columns: repeat(6, minmax(0, 1fr));
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .gap-3 {
            gap: 0.75rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .gap-6 {
            gap: 1.5rem;
        }
        
        .gap-8 {
            gap: 2rem;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .items-center {
            align-items: center;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-3 {
            margin-top: 0.75rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mt-6 {
            margin-top: 1.5rem;
        }
        
        .mt-8 {
            margin-top: 2rem;
        }
        
        .p-1 {
            padding: 0.25rem;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .p-3 {
            padding: 0.75rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-6 {
            padding: 1.5rem;
        }
        
        .px-1 {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        
        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .px-8 {
            padding-left: 2rem;
            padding-right: 2rem;
        }
        
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        
        .py-1.5 {
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .inline-flex {
            display: inline-flex;
        }
        
        .max-w-2xl {
            max-width: 42rem;
        }
        
        .max-w-md {
            max-width: 28rem;
        }
        
        .max-w-7xl {
            max-width: 80rem;
        }
        
        .w-full {
            width: 100%;
        }
        
        .w-24 {
            width: 6rem;
        }
        
        .h-24 {
            height: 6rem;
        }
        
        .h-4 {
            height: 1rem;
        }
        
        .min-h-screen {
            min-height: 100vh;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        .max-h-\[400px\] {
            max-height: 400px;
        }
        
        .rounded {
            border-radius: 0.25rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .border {
            border-width: 1px;
        }
        
        .border-2 {
            border-width: 2px;
        }
        
        .border-t {
            border-top-width: 1px;
        }
        
        .border-b {
            border-bottom-width: 1px;
        }
        
        .border-transparent {
            border-color: transparent;
        }
        
        .border-gray-700 {
            border-color: #374151;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-base {
            font-size: 1rem;
            line-height: 1.5rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        
        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        
        .text-4xl {
            font-size: 2.25rem;
            line-height: 2.5rem;
        }
        
        .text-6xl {
            font-size: 3.75rem;
            line-height: 1;
        }
        
        .leading-tight {
            line-height: 1.25;
        }
        
        .text-white {
            color: #FFFFFF;
        }
        
        .text-gray-300 {
            color: #D1D5DB;
        }
        
        .text-gray-400 {
            color: #9CA3AF;
        }
        
        .text-gray-500 {
            color: #6B7280;
        }
        
        .text-primary {
            color: #6C5CE7;
        }
        
        .text-player1 {
            color: #0984E3;
        }
        
        .text-player2 {
            color: #E74C3C;
        }
        
        .text-yellow-400 {
            color: #FFD700;
        }
        
        .text-shieldBounce {
            color: #9C27B0;
        }
        
        .text-shieldPierce {
            color: #00BCD4;
        }
        
        .text-shieldExplosive {
            color: #FF9800;
        }
        
        .text-shieldFreeze {
            color: #8BC34A;
        }
        
        .text-obstacleStrong {
            color: #795548;
        }
        
        .text-obstacleReflect {
            color: #607D8B;
        }
        
        .bg-dark {
            background-color: #2D3436;
        }
        
        .bg-dark\/30 {
            background-color: rgba(45, 52, 54, 0.3);
        }
        
        .bg-dark\/50 {
            background-color: rgba(45, 52, 54, 0.5);
        }
        
        .bg-dark\/80 {
            background-color: rgba(45, 52, 54, 0.8);
        }
        
        .bg-dark\/95 {
            background-color: rgba(45, 52, 54, 0.95);
        }
        
        .bg-primary {
            background-color: #6C5CE7;
        }
        
        .bg-primary\/10 {
            background-color: rgba(108, 92, 231, 0.1);
        }
        
        .bg-primary\/30 {
            background-color: rgba(108, 92, 231, 0.3);
        }
        
        .bg-secondary {
            background-color: #00D2D3;
        }
        
        .bg-accent {
            background-color: #FC5C65;
        }
        
        .bg-accent\/80 {
            background-color: rgba(252, 92, 101, 0.8);
        }
        
        .bg-player1\/20 {
            background-color: rgba(9, 132, 227, 0.2);
        }
        
        .bg-player1\/30 {
            background-color: rgba(9, 132, 227, 0.3);
        }
        
        .bg-player1\/40 {
            background-color: rgba(9, 132, 227, 0.4);
        }
        
        .bg-player2\/20 {
            background-color: rgba(231, 76, 60, 0.2);
        }
        
        .bg-player2\/30 {
            background-color: rgba(231, 76, 60, 0.3);
        }
        
        .bg-player2\/40 {
            background-color: rgba(231, 76, 60, 0.4);
        }
        
        .bg-gray-700 {
            background-color: #374151;
        }
        
        .bg-gray-600 {
            background-color: #4B5563;
        }
        
        .bg-transparent {
            background-color: transparent;
        }
        
        .opacity-50 {
            opacity: 0.5;
        }
        
        .opacity-70 {
            opacity: 0.7;
        }
        
        .opacity-80 {
            opacity: 0.8;
        }
        
        .opacity-90 {
            opacity: 0.9;
        }
        
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .list-disc {
            list-style-type: disc;
        }
        
        .pl-5 {
            padding-left: 1.25rem;
        }
        
        .relative {
            position: relative;
        }
        
        .absolute {
            position: absolute;
        }
        
        .fixed {
            position: fixed;
        }
        
        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        .top-0 {
            top: 0;
        }
        
        .bottom-0 {
            bottom: 0;
        }
        
        .left-0 {
            left: 0;
        }
        
        .right-0 {
            right: 0;
        }
        
        .top-50 {
            top: 50%;
        }
        
        .left-50 {
            left: 50%;
        }
        
        .transform {
            transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }
        
        .translate-x-0 {
            --tw-translate-x: 0;
        }
        
        .translate-y-0 {
            --tw-translate-y: 0;
        }
        
        .-translate-x-1\/2 {
            --tw-translate-x: -50%;
        }
        
        .-translate-y-1\/2 {
            --tw-translate-y: -50%;
        }
        
        .scale-100 {
            --tw-scale-x: 1;
            --tw-scale-y: 1;
        }
        
        .scale-105 {
            --tw-scale-x: 1.05;
            --tw-scale-y: 1.05;
        }
        
        .scale-95 {
            --tw-scale-x: 0.95;
            --tw-scale-y: 0.95;
        }
        
        .scale-150 {
            --tw-scale-x: 1.5;
            --tw-scale-y: 1.5;
        }
        
        .rotate-0 {
            --tw-rotate: 0deg;
        }
        
        .pointer-events-none {
            pointer-events: none;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
        
        .cursor-not-allowed {
            cursor: not-allowed;
        }
        
        .z-10 {
            z-index: 10;
        }
        
        .z-15 {
            z-index: 15;
        }
        
        .z-20 {
            z-index: 20;
        }
        
        .z-50 {
            z-index: 50;
        }
        
        .hidden {
            display: none;
        }
        
        .block {
            display: block;
        }
        
        .inline-block {
            display: inline-block;
        }
        
        .table {
            display: table;
        }
        
        .min-w-\[60px\] {
            min-width: 60px;
        }
        
        .aspect-\[4\/2\.4\] {
            aspect-ratio: 4 / 2.4;
        }
        
        /* åŠ¨ç”»ç±» */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-pulse-fast {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* è¿‡æ¸¡æ•ˆæœ */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .transition-opacity {
            transition-property: opacity;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .transition-colors {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        /* æ‚¬åœæ•ˆæœ */
        .hover\:bg-primary\/80:hover {
            background-color: rgba(108, 92, 231, 0.8);
        }
        
        .hover\:bg-secondary\/80:hover {
            background-color: rgba(0, 210, 211, 0.8);
        }
        
        .hover\:bg-accent:hover {
            background-color: #FC5C65;
        }
        
        .hover\:bg-accent\/80:hover {
            background-color: rgba(252, 92, 101, 0.8);
        }
        
        .hover\:bg-gray-600:hover {
            background-color: #4B5563;
        }
        
        .hover\:scale-105:hover {
            --tw-scale-x: 1.05;
            --tw-scale-y: 1.05;
        }
        
        .hover\:border-white:hover {
            border-color: #FFFFFF;
        }
        
        .active\:scale-95:active {
            --tw-scale-x: 0.95;
            --tw-scale-y: 0.95;
        }
        
        .disabled\:opacity-50:disabled {
            opacity: 0.5;
        }
        
        .disabled\:cursor-not-allowed:disabled {
            cursor: not-allowed;
        }
        
        .disabled\:hover\:scale-100:disabled:hover {
            --tw-scale-x: 1;
            --tw-scale-y: 1;
        }
        
        /* è‡ªå®šä¹‰å­—ä½“ */
        @font-face {
            font-family: 'Orbitron';
            src: url('fonts/orbitron-regular.woff2') format('woff2'),
                 url('fonts/orbitron-regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Orbitron';
            src: url('fonts/orbitron-medium.woff2') format('woff2'),
                 url('fonts/orbitron-medium.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Orbitron';
            src: url('fonts/orbitron-semibold.woff2') format('woff2'),
                 url('fonts/orbitron-semibold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Orbitron';
            src: url('fonts/orbitron-bold.woff2') format('woff2'),
                 url('fonts/orbitron-bold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }
        
        /* å›¾æ ‡æ›¿ä»£ */
        .icon-bolt::before {
            content: "âš¡";
            margin-right: 0.5rem;
        }
        
        .icon-circle::before {
            content: "â—";
            margin-right: 0.5rem;
        }
        
        .icon-clock::before {
            content: "â±";
            margin-right: 0.5rem;
        }
        
        .icon-signal::before {
            content: "ğŸ“¶";
            margin-right: 0.5rem;
        }
        
        .icon-trophy::before {
            content: "ğŸ†";
            margin-left: 0.5rem;
        }
        
        .icon-play::before {
            content: "â–¶";
            margin-left: 0.5rem;
        }
        
        .icon-refresh::before {
            content: "ğŸ”„";
            margin-left: 0.5rem;
        }
        
        .icon-sign-out::before {
            content: "ğŸšª";
            margin-left: 0.5rem;
        }
        
        .icon-home::before {
            content: "ğŸ ";
            margin-left: 0.5rem;
        }
        
        .icon-trash::before {
            content: "ğŸ—‘";
            margin-left: 0.25rem;
        }
        
        .icon-times::before {
            content: "âœ•";
        }
    </style>
    
    <!-- éŸ³æ•ˆé¢„åŠ è½½ -->
    <audio id="sndLoading"  src="SE/Loading.mp3"  preload="auto"></audio>
    <audio id="sndGameOver" src="SE/GameOver.mp3" preload="auto"></audio>
    <audio id="sndClick"    src="SE/Click.mp3"    preload="auto"></audio>
    <audio id="sndShootP1"  src="SE/se_one.mp3"   preload="auto"></think>
    <audio id="sndShootP2"  src="SE/se_two.mp3"   preload="auto"></audio>

    <script>
        // ç»Ÿä¸€æ’­æ”¾å‡½æ•°ï¼ˆé‡å¤æ’­æ”¾ã€éŸ³é‡æ§åˆ¶ï¼‰
        function playSE(id, volume = 0.6) {
            const el = document.getElementById(id);
            if (!el) return;
            el.currentTime = 0;
            el.volume = volume;
            el.play().catch(()=>{});
        }
    </script>
</head>
<body class="bg-game text-light min-h-screen font-game overflow-x-hidden">
    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-dark">
        <div class="w-24 h-24 border-4 border-primary border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-bold text-primary animate-pulse-fast">åŠ è½½ä¸­...</h2>
        <div id="loadProgress" class="mt-4 text-sm text-gray-400">å‡†å¤‡èµ„æº...</div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto px-1 py-0 max-w-7xl hidden" id="gameContainer">
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="game-container relative mb-6">
            <canvas id="gameCanvas" class="game-canvas w-full max-w-7xl aspect-[4/2.4] bg-dark/50 rounded-lg pixel-border shadow-xl"></canvas>
            <div id="roundTransition" class="round-transition"></div>
            <div id="gameOverlay" class="absolute inset-0 bg-dark/80 rounded-lg flex flex-col items-center justify-center z-10">
                <h2 class="text-3xl font-bold mb-8 text-primary text-shadow">æ¸¸æˆå¼€å§‹</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 w-full max-w-2xl px-4">
                    <!-- ç©å®¶1è§’è‰²é€‰æ‹© -->
                    <div class="player-select">
                        <h3 class="text-xl font-semibold mb-4 text-player1">ç©å®¶1 è§’è‰²é€‰æ‹©</h3>
                        <div class="grid grid-cols-3 gap-3" id="p1Characters">
                            <div class="character-option bg-player1/20 hover:bg-player1/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="lightning">
                                <h4 class="font-bold">é—ªç”µå…ˆé”‹</h4>
                                <p class="text-sm text-gray-300">é€Ÿåº¦+25% æš´å‡»æœºä¼š</p>
                            </div>
                            <div class="character-option bg-player1/20 hover:bg-player1/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="heavy">
                                <h4 class="font-bold">é‡ç”²å ¡å’</h4>
                                <p class="text-sm text-gray-300">ä¼¤å®³+1 æŠ¤ç”²+4 æŠ¤ç›¾é˜²å¾¡</p>
                            </div>
                            <div class="character-option bg-player1/20 hover:bg-player1/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="tactical">
                                <h4 class="font-bold">æˆ˜æœ¯ä¸“å®¶</h4>
                                <p class="text-sm text-gray-300">ç©¿é€å°„å‡» å‡»ç ´å¥–åŠ±</p>
                            </div>
                        </div>
                    </div>
                    <!-- ç©å®¶2è§’è‰²é€‰æ‹© -->
                    <div class="player-select">
                        <h3 class="text-xl font-semibold mb-4 text-player2">ç©å®¶2 è§’è‰²é€‰æ‹©</h3>
                        <div class="grid grid-cols-3 gap-3" id="p2Characters">
                            <div class="character-option bg-player2/20 hover:bg-player2/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="lightning">
                                <h4 class="font-bold">é—ªç”µå…ˆé”‹</h4>
                                <p class="text-sm text-gray-300">é€Ÿåº¦+25% æš´å‡»æœºä¼š</p>
                            </div>
                            <div class="character-option bg-player2/20 hover:bg-player2/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="heavy">
                                <h4 class="font-bold">é‡ç”²å ¡å’</h4>
                                <p class="text-sm text-gray-300">ä¼¤å®³+1 æŠ¤ç”²+4 æŠ¤ç›¾é˜²å¾¡</p>
                            </div>
                            <div class="character-option bg-player2/20 hover:bg-player2/40 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-type="tactical">
                                <h4 class="font-bold">æˆ˜æœ¯ä¸“å®¶</h4>
                                <p class="text-sm text-gray-300">ç©¿é€å°„å‡» å‡»ç ´å¥–åŠ±</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
                <div class="mb-8 w-full max-w-md">
                    <h3 class="text-xl font-semibold mb-4 text-primary">æ¸¸æˆæ¨¡å¼</h3>
                    <div class="grid grid-cols-2 gap-3" id="gameModes">
                        <div class="mode-option bg-dark/50 hover:bg-primary/30 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-mode="standard">
                            <h4 class="font-bold">æ ‡å‡†æ¨¡å¼</h4>
                            <p class="text-sm text-gray-300">10åˆ†é’Ÿé™æ—¶</p>
                        </div>
                        <div class="mode-option bg-dark/50 hover:bg-primary/30 p-3 rounded-lg cursor-pointer transition-all border-2 border-transparent hover:border-white" data-mode="rounds">
                            <h4 class="font-bold">å›åˆåˆ¶</h4>
                            <p class="text-sm text-gray-300">3å±€2èƒœ</p>
                        </div>
                    </div>
                </div>
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="flex gap-4 mb-6">
                    <button id="viewStats" class="bg-secondary hover:bg-secondary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        æŸ¥çœ‹æˆ˜ç»© <span class="icon-trophy"></span>
                    </button>
                    <button id="startGame" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" disabled>
                        å¼€å§‹æ¸¸æˆ <span class="icon-play"></span>
                    </button>
                </div>
            </div>
            <!-- æš‚åœèœå• -->
            <div id="pauseMenu" class="absolute inset-0 bg-dark/80 rounded-lg flex flex-col items-center justify-center z-10 hidden">
                <h2 class="text-3xl font-bold mb-8 text-primary text-shadow">æ¸¸æˆæš‚åœ</h2>
                <div class="flex flex-col gap-4">
                    <button id="resumeGame" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        ç»§ç»­æ¸¸æˆ <span class="icon-play"></span>
                    </button>
                    <button id="restartGame" class="bg-secondary hover:bg-secondary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        é‡æ–°å¼€å§‹ <span class="icon-refresh"></span>
                    </button>
                    <button id="viewStatsPause" class="bg-accent/80 hover:bg-accent text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        æŸ¥çœ‹æˆ˜ç»© <span class="icon-trophy"></span>
                    </button>
                    <button id="quitGame" class="bg-accent hover:bg-accent/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        é€€å‡ºæ¸¸æˆ <span class="icon-sign-out"></span>
                    </button>
                </div>
            </div>
            <!-- æ¸¸æˆç»“æŸèœå• -->
            <div id="gameOverMenu" class="absolute inset-0 bg-dark/80 rounded-lg flex flex-col items-center justify-center z-10 hidden">
                <h2 class="text-3xl font-bold mb-4 text-primary text-shadow" id="winnerText">ç©å®¶1 èƒœåˆ©!</h2>
                <p class="text-xl mb-8 text-gray-300" id="winReason">æˆåŠŸå‡»ç ´å¯¹æ‰‹æŠ¤ç”²!</p>
                <div class="flex gap-4">
                    <button id="playAgain" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        å†ç©ä¸€æ¬¡ <span class="icon-refresh"></span>
                    </button>
                    <button id="viewStatsEnd" class="bg-secondary hover:bg-secondary/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        æŸ¥çœ‹æˆ˜ç»© <span class="icon-trophy"></span>
                    </button>
                    <button id="backToMenu" class="bg-accent hover:bg-accent/80 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                        è¿”å›èœå• <span class="icon-home"></span>
                    </button>
                </div>
            </div>
            <!-- å›åˆç»“æœ -->
            <div id="roundResult" class="absolute inset-0 bg-dark/60 rounded-lg flex flex-col items-center justify-center z-10 hidden">
                <h2 class="text-4xl font-bold mb-6 text-primary text-shadow" id="roundWinnerText">ç©å®¶1 èµ¢å¾—æœ¬å±€!</h2>
                <p class="text-xl text-gray-300" id="nextRoundText">ä¸‹ä¸€å›åˆå°†åœ¨ 3 ç§’åå¼€å§‹...</p>
            </div>
            <!-- æˆ˜ç»©é¢æ¿ -->
            <div id="statsPanel" class="absolute inset-0 bg-dark/95 rounded-lg flex flex-col items-center justify-center z-20 hidden">
                <div class="w-full max-w-2xl p-6 bg-dark/80 rounded-lg pixel-border">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-primary text-shadow">æ¸¸æˆæˆ˜ç»©</h2>
                        <div class="flex gap-2">
                            <button id="clearStats" class="bg-accent/80 hover:bg-accent text-white font-bold py-1.5 px-4 rounded-lg transition-all transform hover:scale-105 active:scale-95 text-sm">
                                æ¸…ç©ºè®°å½• <span class="icon-trash"></span>
                            </button>
                            <button id="closeStats" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1.5 px-4 rounded-lg transition-all transform hover:scale-105 active:scale-95">
                                <span class="icon-times"></span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-[400px] scrollbar-hidden mb-4">
                        <div class="grid grid-cols-6 gap-2 text-sm font-bold text-gray-400 mb-2 pb-2 border-b border-gray-700">
                            <div>æ—¥æœŸ</div>
                            <div>æ¨¡å¼</div>
                            <div>èƒœè€…</div>
                            <div>æ—¶é•¿</div>
                            <div>ç©å®¶1è§’è‰²</div>
                            <div>ç©å®¶2è§’è‰²</div>
                        </div>
                        <div id="statsList" class="space-y-2">
                            <div class="text-center text-gray-500 py-8" id="noStatsMessage">
                                æš‚æ— æˆ˜ç»©è®°å½•
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-400 mt-4 pt-4 border-t border-gray-700">
                        <div>
                            <span class="text-player1 font-bold">ç©å®¶1 èƒœç‡:</span> <span id="p1WinRate">0%</span>
                        </div>
                        <div>
                            <span class="text-player2 font-bold">ç©å®¶2 èƒœç‡:</span> <span id="p2WinRate">0%</span>
                        </div>
                        <div>
                            <span class="text-primary font-bold">æ€»åœºæ¬¡:</span> <span id="totalGames">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ç‰¹æ•ˆå®¹å™¨ -->
            <div id="powerupIndicators" class="absolute inset-0 pointer-events-none z-15"></div>
            <div id="specialEffects" class="absolute inset-0 pointer-events-none z-5"></div>
        </div>
        <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="gameInfoPanel">
            <div class="bg-player1/10 rounded-lg p-4 pixel-border">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-player1">ç©å®¶1</h3>
                    <div id="p1CharacterType" class="text-sm bg-player1/30 px-2 py-1 rounded">é—ªç”µå…ˆé”‹</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-400">æŠ¤ç”²</p>
                        <div class="flex gap-1 mt-1" id="p1Armor">
                            <div class="w-4 h-4 bg-player1 rounded-full"></div>
                            <div class="w-4 h-4 bg-player1 rounded-full"></div>
                            <div class="w-4 h-4 bg-player1 rounded-full"></div>
                            <div class="w-4 h-4 bg-gray-600 rounded-full opacity-50"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">å­å¼¹</p>
                        <div class="flex items-center mt-1">
                            <span class="icon-circle text-player1"></span>
                            <span id="p1Ammo" class="font-bold">10/10</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">æŠ€èƒ½å­å¼¹</p>
                        <div class="flex items-center mt-1">
                            <span class="icon-bolt text-yellow-400"></span>
                            <span id="p1SpecialAmmo" class="font-bold">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ä¸­å¤®ä¿¡æ¯é¢æ¿ -->
            <div class="bg-primary/10 rounded-lg p-4 pixel-border text-center">
                <div class="flex justify-center items-center gap-2 mb-2">
                    <span class="icon-clock text-primary text-xl"></span>
                    <span id="gameTime" class="text-xl font-bold">00:00</span>
                </div>
                <div class="flex justify-center items-center gap-2 mb-2">
                    <span class="icon-signal text-primary text-xl"></span>
                    <span id="gamePhase" class="text-lg">å‡†å¤‡é˜¶æ®µ</span>
                </div>
                <div class="flex justify-center gap-4 mt-3">
                    <div>
                        <p class="text-sm text-gray-400">å›åˆ</p>
                        <span id="roundNumber" class="font-bold">1/3</span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">P1èƒœåœº</p>
                        <span id="p1Wins" class="font-bold text-player1">0</span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">P2èƒœåœº</p>
                        <span id="p2Wins" class="font-bold text-player2">0</span>
                    </div>
                </div>
            </div>
            <!-- ç©å®¶2ä¿¡æ¯ -->
            <div class="bg-player2/10 rounded-lg p-4 pixel-border">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-player2">ç©å®¶2</h3>
                    <div id="p2CharacterType" class="text-sm bg-player2/30 px-2 py-1 rounded">é—ªç”µå…ˆé”‹</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-400">æŠ¤ç”²</p>
                        <div class="flex gap-1 mt-1" id="p2Armor">
                            <div class="w-4 h-4 bg-player2 rounded-full"></div>
                            <div class="w-4 h-4 bg-player2 rounded-full"></div>
                            <div class="w-4 h-4 bg-player2 rounded-full"></div>
                            <div class="w-4 h-4 bg-gray-600 rounded-full opacity-50"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">å­å¼¹</p>
                        <div class="flex items-center mt-1">
                            <span class="icon-circle text-player2"></span>
                            <span id="p2Ammo" class="font-bold">10/10</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">æŠ€èƒ½å­å¼¹</p>
                        <div class="flex items-center mt-1">
                            <span class="icon-bolt text-yellow-400"></span>
                            <span id="p2SpecialAmmo" class="font-bold">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- æ¸¸æˆæ§åˆ¶è¯´æ˜ -->
        <div class="bg-dark/50 rounded-lg p-4 mb-8 pixel-border">
            <h3 class="text-xl font-bold mb-4 text-primary text-center">æ¸¸æˆæ§åˆ¶</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-player1">ç©å®¶1æ§åˆ¶</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">W/S</span>
                            <span>ä¸Šä¸‹ç§»åŠ¨</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">ç©ºæ ¼</span>
                            <span>å°„å‡»ï¼ˆæ™®é€šï¼‰</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">A/D</span>
                            <span>å·¦å³æ­ªå¤´ï¼ˆæ–œå°„ï¼‰</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">Q</span>
                            <span>æŠ€èƒ½å­å¼¹</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-player2">ç©å®¶2æ§åˆ¶</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">â†‘/â†“</span>
                            <span>ä¸Šä¸‹ç§»åŠ¨</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">Enter</span>
                            <span>å°„å‡»ï¼ˆæ™®é€šï¼‰</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">â†/â†’</span>
                            <span>å·¦å³æ­ªå¤´ï¼ˆæ–œå°„ï¼‰</span>
                        </div>
                        <div class="flex items-center">
                            <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">P</span>
                            <span>æŠ€èƒ½å­å¼¹</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center">
                <div class="inline-flex items-center bg-dark/50 px-4 py-2 rounded-lg">
                    <span class="bg-dark px-2 py-1 rounded mr-3 min-w-[60px] text-center font-mono">Esc</span>
                    <span>æš‚åœæ¸¸æˆ</span>
                </div>
            </div>
        </div>
        <!-- æ¸¸æˆè¯´æ˜ -->
        <div class="bg-dark/30 rounded-lg p-4 mb-8 text-sm">
            <h3 class="text-lg font-bold mb-2 text-primary">æ¸¸æˆè¯´æ˜</h3>
            <p class="mb-2">æŒ¡æ¿å°„æ‰‹æ˜¯ä¸€æ¬¾åŒäººå¯¹æˆ˜æ¸¸æˆï¼Œç©å®¶é€šè¿‡æ§åˆ¶æŒ¡æ¿å‘å°„å­å¼¹æ”»å‡»å¯¹æ‰‹ï¼Œå‡»ç ´å¯¹æ–¹æ‰€æœ‰æŠ¤ç”²å³å¯è·èƒœã€‚ä¸­é—´åŒºåŸŸä¼šå‡ºç°å¤šç§ç‰¹æ®ŠæŒ¡æ¿ï¼Œå„æœ‰ä¸åŒæ•ˆæœã€‚</p>
            <p class="mb-2">è§’è‰²ç‰¹æ€§ï¼š</p>
            <ul class="list-disc pl-5 mb-2">
                <li><span class="font-bold">é—ªç”µå…ˆé”‹</span>ï¼šç§»åŠ¨é€Ÿåº¦+25%ï¼Œè¿ç»­ç§»åŠ¨3ç§’åä¸‹ä¸€æ¬¡å°„å‡»å¿…å®šæš´å‡»</li>
                <li><span class="font-bold">é‡ç”²å ¡å’</span>ï¼šä¼¤å®³+1ï¼ŒåŸºç¡€æŠ¤ç”²å€¼ä¸º4ï¼Œæ‰¿å—3æ¬¡æ”»å‡»åæ¿€æ´»æŠ¤ç›¾æŠµæŒ¡æ”»å‡»ï¼ˆæŒç»­5ç§’ï¼‰</li>
                <li><span class="font-bold">æˆ˜æœ¯ä¸“å®¶</span>ï¼šå­å¼¹å¯ç©¿é€ä¸€ä¸ªéšœç¢ç‰©ï¼Œå‡»ç ´éšœç¢ç‰©æœ‰50%å‡ ç‡æ¢å¤1å‘å¼¹è¯æˆ–æŠ€èƒ½å­å¼¹</li>
            </ul>
            <p class="mb-2">æŒ¡æ¿ç±»å‹ï¼š</p>
            <ul class="list-disc pl-5 mb-2">
                <li><span class="text-shieldBounce">ç´«è‰²ï¼ˆå¼¹è·³æŒ¡æ¿ï¼‰</span>ï¼šå‡»ä¸­åè·å¾—å¼¹è·³å­å¼¹ï¼Œå¯åå¼¹å¤šæ¬¡</li>
                <li><span class="text-shieldPierce">é’è‰²ï¼ˆç©¿é€æŒ¡æ¿ï¼‰</span>ï¼šå‡»ä¸­åè·å¾—ç©¿é€å­å¼¹ï¼Œå¯ç©¿é€æ•ŒäººæŠ¤ç”²</li>
                <li><span class="text-shieldExplosive">æ©™è‰²ï¼ˆçˆ†ç‚¸æŒ¡æ¿ï¼‰</span>ï¼šå‡»ä¸­åè·å¾—çˆ†ç‚¸å­å¼¹ï¼Œå‘½ä¸­åäº§ç”ŸèŒƒå›´ä¼¤å®³</li>
                <li><span class="text-shieldFreeze">ç»¿è‰²ï¼ˆå†°å†»æŒ¡æ¿ï¼‰</span>ï¼šå‡»ä¸­åè·å¾—å†°å†»å­å¼¹ï¼Œå‘½ä¸­åå‡ç¼“æ•Œäººç§»åŠ¨</li>
                <li><span class="text-obstacleStrong">æ£•è‰²ï¼ˆå¼ºåŒ–éšœç¢ï¼‰</span>ï¼šéœ€è¦2æ¬¡å‡»ä¸­æ‰èƒ½ç ´å</li>
                <li><span class="text-obstacleReflect">ç°è‰²ï¼ˆæŠ˜å°„æŒ¡æ¿ï¼‰</span>ï¼šå­å¼¹ä¼šæ ¹æ®æ³•çº¿åŸç†æŠ˜å°„</li>
            </ul>
            <p>æ‰€æœ‰è§’è‰²æ¯5ç§’è‡ªåŠ¨è£…å¡«1å‘å­å¼¹ï¼ˆå­å¼¹æœªæ»¡æ—¶ï¼‰</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½è¿›åº¦æ›´æ–°å‡½æ•°
            const updateLoadProgress = (message) => {
                const progressEl = document.getElementById('loadProgress');
                if (progressEl) progressEl.textContent = message;
            };

            // ä¸»æ¸¸æˆç±»
            class PaddleShooter {
                constructor() {
                    updateLoadProgress('åˆå§‹åŒ–æ¸¸æˆç¯å¢ƒ...');
                    this.player1SkillType = null;
                    this.player2SkillType = null;
                    this.canvas = document.getElementById('gameCanvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.gameOverlay = document.getElementById('gameOverlay');
                    this.pauseMenu = document.getElementById('pauseMenu');
                    this.gameOverMenu = document.getElementById('gameOverMenu');
                    this.gameInfoPanel = document.getElementById('gameInfoPanel');
                    this.roundResult = document.getElementById('roundResult');
                    this.roundWinnerText = document.getElementById('roundWinnerText');
                    this.nextRoundText = document.getElementById('nextRoundText');
                    this.roundTransition = document.getElementById('roundTransition');
                    this.powerupIndicators = document.getElementById('powerupIndicators');
                    this.statsPanel = document.getElementById('statsPanel');
                    this.statsList = document.getElementById('statsList');
                    this.noStatsMessage = document.getElementById('noStatsMessage');
                    this.specialEffects = document.getElementById('specialEffects');
                    
                    // åˆå§‹åŒ–å¯¹è±¡æ± 
                    this.initPools();
                    
                    // è°ƒæ•´ç”»å¸ƒå¤§å°
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());
                    
                    // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
                    this.gameState = 'preparing';
                    this.selectedP1Char = 'lightning';
                    this.selectedP2Char = 'lightning';
                    this.selectedMode = 'standard';
                    this.lastTime = 0;
                    this.deltaTime = 0;
                    this.lastReloadTime = Date.now();
                    this.obstacles = [];
                    this.bullets = [];
                    this.player1 = null;
                    this.player2 = null;
                    
                    // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®å’Œäº‹ä»¶ç›‘å¬å™¨
                    this.initStats();
                    this.initEventListeners();
                    this.resetGame();
                    window.gameInstance = this;
                }

                // åˆå§‹åŒ–å¯¹è±¡æ± 
                initPools() {
                    this.powerupIndicatorPool = [];
                    this.criticalIndicatorPool = [];
                    this.bulletEffectPool = [];
                    
                    // åˆ›å»º5ä¸ªç‰¹æ•ˆæŒ‡ç¤ºå™¨
                    for (let i = 0; i < 5; i++) {
                        const indicator = document.createElement('div');
                        indicator.className = 'powerup-indicator';
                        indicator.style.display = 'none';
                        this.powerupIndicators.appendChild(indicator);
                        this.powerupIndicatorPool.push(indicator);
                        
                        const critical = document.createElement('div');
                        critical.className = 'critical-indicator';
                        critical.style.display = 'none';
                        this.specialEffects.appendChild(critical);
                        this.criticalIndicatorPool.push(critical);
                        
                        const bulletEffect = document.createElement('div');
                        bulletEffect.className = 'bullet-effect';
                        bulletEffect.style.display = 'none';
                        this.specialEffects.appendChild(bulletEffect);
                        this.bulletEffectPool.push(bulletEffect);
                    }
                }

                // è·å–å¯ç”¨çš„ç‰¹æ•ˆæŒ‡ç¤ºå™¨
                getPowerupIndicator() {
                    for (let i = 0; i < this.powerupIndicatorPool.length; i++) {
                        const indicator = this.powerupIndicatorPool[i];
                        if (indicator.style.display === 'none') return indicator;
                    }
                    
                    // å¦‚æœæ²¡æœ‰å¯ç”¨çš„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                    const indicator = document.createElement('div');
                    indicator.className = 'powerup-indicator';
                    indicator.style.display = 'none';
                    this.powerupIndicators.appendChild(indicator);
                    this.powerupIndicatorPool.push(indicator);
                    return indicator;
                }

                // è·å–æš´å‡»æŒ‡ç¤ºå™¨
                getCriticalIndicator() {
                    for (let i = 0; i < this.criticalIndicatorPool.length; i++) {
                        const indicator = this.criticalIndicatorPool[i];
                        if (indicator.style.display === 'none') return indicator;
                    }
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'critical-indicator';
                    indicator.style.display = 'none';
                    this.specialEffects.appendChild(indicator);
                    this.criticalIndicatorPool.push(indicator);
                    return indicator;
                }

                // è·å–å­å¼¹ç‰¹æ•ˆ
                getBulletEffect() {
                    for (let i = 0; i < this.bulletEffectPool.length; i++) {
                        const effect = this.bulletEffectPool[i];
                        if (effect.style.display === 'none') return effect;
                    }
                    
                    const effect = document.createElement('div');
                    effect.className = 'bullet-effect';
                    effect.style.display = 'none';
                    this.specialEffects.appendChild(effect);
                    this.bulletEffectPool.push(effect);
                    return effect;
                }

                // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
                initStats() {
                    try {
                        const savedStats = localStorage.getItem('paddleShooterStats');
                        this.stats = savedStats ? JSON.parse(savedStats) : [];
                        this.displayStats();
                    } catch (e) {
                        console.error('åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
                        this.stats = [];
                    }
                }

                // ä¿å­˜ç»Ÿè®¡æ•°æ®
                saveStats() {
                    try {
                        localStorage.setItem('paddleShooterStats', JSON.stringify(this.stats));
                        this.displayStats();
                    } catch (e) {
                        console.error('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
                    }
                }

                // è®°å½•æ¸¸æˆç»“æœ
                recordGameResult(winner, reason) {
                    const now = new Date();
                    const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    const minutes = Math.floor(this.gameTime / 60).toString().padStart(2, '0');
                    const seconds = (this.gameTime % 60).toString().padStart(2, '0');
                    const gameDuration = `${minutes}:${seconds}`;
                    
                    // è§’è‰²ç±»å‹åç§°æ˜ å°„
                    const charTypeNames = { 'lightning': 'é—ªç”µå…ˆé”‹', 'heavy': 'é‡ç”²å ¡å’', 'tactical': 'æˆ˜æœ¯ä¸“å®¶' };
                    const modeNames = { 'standard': 'æ ‡å‡†æ¨¡å¼', 'rounds': 'å›åˆåˆ¶' };
                    
                    // åˆ›å»ºæ–°è®°å½•
                    const newRecord = {
                        id: Date.now(),
                        date: formattedDate,
                        mode: modeNames[this.selectedMode],
                        winner: winner === 'p1' ? 'ç©å®¶1' : 'ç©å®¶2',
                        duration: gameDuration,
                        p1Character: charTypeNames[this.selectedP1Char],
                        p2Character: charTypeNames[this.selectedP2Char],
                        reason: reason
                    };
                    
                    // æ·»åŠ åˆ°ç»Ÿè®¡åˆ—è¡¨
                    this.stats.unshift(newRecord);
                    if (this.stats.length > 50) this.stats.pop();
                    this.saveStats();
                }

                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                displayStats() {
                    try {
                        this.statsList.innerHTML = '';
                        
                        if (this.stats.length === 0) {
                            this.statsList.appendChild(this.noStatsMessage);
                        } else {
                            // æ˜¾ç¤ºæœ€è¿‘çš„10æ¡è®°å½•
                            this.stats.slice(-10).reverse().forEach(record => {
                                const row = document.createElement('div');
                                row.className = 'grid grid-cols-6 gap-2 py-2 px-1 rounded stats-row text-sm';
                                const winnerClass = record.winner === 'ç©å®¶1' ? 'text-player1 font-bold' : 'text-player2 font-bold';
                                
                                row.innerHTML = `
                                    <div>${record.date}</div>
                                    <div>${record.mode}</div>
                                    <div class="${winnerClass}">${record.winner}</div>
                                    <div>${record.duration}</div>
                                    <div>${record.p1Character}</div>
                                    <div>${record.p2Character}</div>
                                `;
                                
                                this.statsList.appendChild(row);
                            });
                        }
                        
                        // è®¡ç®—èƒœç‡
                        const total = this.stats.length;
                        const p1Wins = this.stats.filter(g => g.winner === 'ç©å®¶1').length;
                        
                        document.getElementById('totalGames').textContent = total;
                        document.getElementById('p1WinRate').textContent = total ? `${Math.round(p1Wins / total * 100)}%` : '0%';
                        document.getElementById('p2WinRate').textContent = total ? `${Math.round((total - p1Wins) / total * 100)}%` : '0%';
                    } catch (e) {
                        console.error('æ˜¾ç¤ºç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
                    }
                }

                // æ¸…ç©ºç»Ÿè®¡æ•°æ®
                clearStats() {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æˆ˜ç»©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        this.stats = [];
                        this.saveStats();
                    }
                }

                // æ˜¾ç¤ºç»Ÿè®¡é¢æ¿
                showStats() { 
                    this.statsPanel.classList.remove('hidden'); 
                    this.pauseGame(); 
                }
                
                // éšè—ç»Ÿè®¡é¢æ¿
                hideStats() { 
                    this.statsPanel.classList.add('hidden'); 
                }

                // è°ƒæ•´ç”»å¸ƒå¤§å°
                resizeCanvas() {
                    try {
                        const container = this.canvas.parentElement;
                        const rect = container.getBoundingClientRect();
                        this.canvas.width = rect.width;
                        this.canvas.height = rect.height;
                        
                        // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œé‡æ–°ç”Ÿæˆéšœç¢ç‰©
                        if (this.obstacles && this.gameState === 'playing') this.generateObstacles();
                    } catch (e) {
                        console.error('è°ƒæ•´ç”»å¸ƒå¤§å°å¤±è´¥:', e);
                    }
                }

                // ç”Ÿæˆéšœç¢ç‰©
                generateObstacles() {
                    this.obstacles = [];
                    const obstacleCount = 6;
                    
                    // éšœç¢ç‰©ç±»å‹åŠå…¶æƒé‡
                    const obstacleTypes = [
                        { type: 'reflect', color: '#607D8B', health: 1, weight: 50 },
                        { type: 'strong', color: '#795548', health: 2, weight: 30 },
                        { type: 'bounce', color: '#9C27B0', health: 1, weight: 5 },
                        { type: 'pierce', color: '#00BCD4', health: 1, weight: 5 },
                        { type: 'explosive', color: '#FF9800', health: 1, weight: 5 },
                        { type: 'freeze', color: '#8BC34A', health: 1, weight: 5 }
                    ];

                    // åŠ æƒéšæœºé€‰æ‹©å‡½æ•°
                    function weightedRandom(types) {
                        const totalWeight = types.reduce((sum, t) => sum + t.weight, 0);
                        let rand = Math.random() * totalWeight;
                        
                        for (const t of types) {
                            if (rand < t.weight) return t;
                            rand -= t.weight;
                        }
                        
                        return types[0];
                    }

                    // æ£€æŸ¥éšœç¢ç‰©æ˜¯å¦é‡å 
                    function isOverlapping(newObstacle, existingObstacles) {
                        const margin = 10;
                        return existingObstacles.some(ob =>
                            newObstacle.x < ob.x + ob.width + margin &&
                            newObstacle.x + newObstacle.width + margin > ob.x &&
                            newObstacle.y < ob.y + ob.height + margin &&
                            newObstacle.y + newObstacle.height + margin > ob.y
                        );
                    }

                    const centerX = this.canvas.width / 2;
                    const centerY = this.canvas.height / 2;
                    const spawnAreaWidth = this.canvas.width * 0.6;
                    const spawnAreaHeight = this.canvas.height * 0.6;

                    // ç”ŸæˆæŒ‡å®šæ•°é‡çš„éšœç¢ç‰©
                    for (let i = 0; i < obstacleCount; i++) {
                        let attempts = 0;
                        let placed = false;
                        
                        while (!placed && attempts < 50) {
                            const type = weightedRandom(obstacleTypes);
                            const width = 12;
                            const height = 100;
                            const x = centerX - spawnAreaWidth / 2 + Math.random() * (spawnAreaWidth - width);
                            const y = centerY - spawnAreaHeight / 2 + Math.random() * (spawnAreaHeight - height);
                            const angle = (Math.random() * 60 - 30) * Math.PI / 180;
                            const lifetime = 8000 + Math.random() * 10000;
                            
                            const newObstacle = { x, y, width, height };
                            
                            // æ£€æŸ¥æ˜¯å¦é‡å ï¼Œå¦‚æœä¸é‡å åˆ™æ·»åŠ éšœç¢ç‰©
                            if (x > 0 && x + width < this.canvas.width && y > 0 && y + height < this.canvas.height && !isOverlapping(newObstacle, this.obstacles)) {
                                this.obstacles.push({
                                    x, y, width, height,
                                    color: type.color,
                                    health: type.health,
                                    type: type.type,
                                    angle,
                                    spawnTime: Date.now(),
                                    lifetime,
                                    isFading: false,
                                    pulseTimer: 0
                                });
                                
                                placed = true;
                            }
                            
                            attempts++;
                        }
                    }
                }

                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
                initEventListeners() {
                    try {
                        const p1Chars = document.querySelectorAll('#p1Characters .character-option');
                        const p2Chars = document.querySelectorAll('#p2Characters .character-option');
                        const modeOptions = document.querySelectorAll('#gameModes .mode-option');

                        // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
                        p1Chars[0].classList.add('selected');
                        p2Chars[0].classList.add('selected');
                        modeOptions[0].classList.add('selected');
                        this.selectedP1Char = 'lightning';
                        this.selectedP2Char = 'lightning';
                        this.selectedMode = 'standard';
                        this.checkStartEnabled();

                        // ç©å®¶1è§’è‰²é€‰æ‹©äº‹ä»¶
                        p1Chars.forEach(el => {
                            el.addEventListener('click', () => {
                                p1Chars.forEach(opt => opt.classList.remove('selected'));
                                el.classList.add('selected');
                                this.selectedP1Char = el.dataset.type;
                                // æ›´æ–°ç©å®¶1è§’è‰²ç±»å‹æ˜¾ç¤º
                                document.getElementById('p1CharacterType').textContent = el.querySelector('h4').textContent;
                                this.checkStartEnabled();
                                playSE('sndClick');
                            });
                        });

                        // ç©å®¶2è§’è‰²é€‰æ‹©äº‹ä»¶
                        p2Chars.forEach(el => {
                            el.addEventListener('click', () => {
                                p2Chars.forEach(opt => opt.classList.remove('selected'));
                                el.classList.add('selected');
                                this.selectedP2Char = el.dataset.type;
                                // æ›´æ–°ç©å®¶2è§’è‰²ç±»å‹æ˜¾ç¤º
                                document.getElementById('p2CharacterType').textContent = el.querySelector('h4').textContent;
                                this.checkStartEnabled();
                                playSE('sndClick');
                            });
                        });

                        // æ¸¸æˆæ¨¡å¼é€‰æ‹©äº‹ä»¶
                        modeOptions.forEach(el => {
                            el.addEventListener('click', () => {
                                modeOptions.forEach(opt => opt.classList.remove('selected'));
                                el.classList.add('selected');
                                this.selectedMode = el.dataset.mode;
                                this.checkStartEnabled();
                                playSE('sndClick');
                            });
                        });

                        // å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶
                        document.getElementById('startGame').addEventListener('click', () => {
                            if (!this.startGame.disabled) {
                                this.startGame();
                            }
                        });

                        // æŸ¥çœ‹æˆ˜ç»©æŒ‰é’®äº‹ä»¶ï¼ˆä¸»èœå•ï¼‰
                        document.getElementById('viewStats').addEventListener('click', () => {
                            this.showStats();
                        });

                        // æš‚åœèœå•æŒ‰é’®äº‹ä»¶
                        document.getElementById('resumeGame').addEventListener('click', () => {
                            this.resumeGame();
                        });
                        document.getElementById('restartGame').addEventListener('click', () => {
                            this.resetGame();
                        });
                        document.getElementById('viewStatsPause').addEventListener('click', () => {
                            this.showStats();
                        });
                        document.getElementById('quitGame').addEventListener('click', () => {
                            this.quitGame();
                        });

                        // æ¸¸æˆç»“æŸèœå•æŒ‰é’®äº‹ä»¶
                        document.getElementById('playAgain').addEventListener('click', () => {
                            this.resetGame();
                        });
                        document.getElementById('viewStatsEnd').addEventListener('click', () => {
                            this.showStats();
                        });
                        document.getElementById('backToMenu').addEventListener('click', () => {
                            this.quitGame();
                        });

                        // æˆ˜ç»©é¢æ¿æŒ‰é’®äº‹ä»¶
                        document.getElementById('closeStats').addEventListener('click', () => {
                            this.hideStats();
                        });
                        document.getElementById('clearStats').addEventListener('click', () => {
                            this.clearStats();
                        });

                        // é”®ç›˜äº‹ä»¶
                        document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                        document.addEventListener('keyup',   (e) => this.handleKeyUp(e));
                    } catch (e) { 
                        console.error('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', e); 
                    }
                }

                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹æ¸¸æˆ
                checkStartEnabled() {
                    const startBtn = document.getElementById('startGame');
                    startBtn.disabled = !(this.selectedP1Char && this.selectedP2Char && this.selectedMode);
                }

                // å¼€å§‹æ¸¸æˆ
                startGame() {
                    try {
                        this.gameOverlay.classList.add('hidden');
                        this.gameInfoPanel.classList.remove('hidden');
                        this.initGameObjects ();
this.showRoundTransition ();
this.gameState = 'playing';
document.getElementById ('gamePhase').textContent = ' æ¸¸æˆè¿›è¡Œä¸­ ';
this.startGameTimer ();
this.lastTime = performance.now ();
this.lastReloadTime = Date.now ();
this.gameLoop ();
} catch (e) {
console.error (' å¼€å§‹æ¸¸æˆå¤±è´¥:', e);
alert (' æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯• ');
}
}

// æ˜¾ç¤ºå›åˆè¿‡æ¸¡åŠ¨ç”»
showRoundTransition () {
this.roundTransition.textContent = ç¬¬ ${this.round} å›åˆ;
this.roundTransition.style.opacity = '1';
this.roundTransition.style.transform = 'translate(-50%, -50%) scale(1)';
this.roundTransition.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

setTimeout(() => {
this.roundTransition.style.opacity = '0';
this.roundTransition.style.transform = 'translate(-50%, -50%) scale(1.5)';
}, 1000);
}

// åˆ›å»ºç©å®¶å¯¹è±¡
createPlayer (playerNumber, charType) {
// è§’è‰²åŸºç¡€å±æ€§
const baseStats = {
lightning: { speed: 3.75, armor: 3, ammo: 10, maxAmmo: 10, fireRate: 850, specialAmmo: 0 },
heavy: { speed: 3, armor: 4, ammo: 8, maxAmmo: 8, fireRate: 1100, specialAmmo: 0 },
tactical: { speed: 3, armor: 3, ammo: 10, maxAmmo: 10, fireRate: 1000, specialAmmo: 0 }
};

const stats = baseStats[charType];
const x = playerNumber === 1 ? 50 : this.canvas.width - 65;
const color = playerNumber === 1 ? '#0984E3' : '#E74C3C';

return {
x,
y: this.canvas.height / 2,
width: 15,
height: 80,
speed: stats.speed,
baseSpeed: stats.speed,
armor: stats.armor,
maxArmor: stats.armor,
ammo: stats.ammo,
maxAmmo: stats.maxAmmo,
specialAmmo: stats.specialAmmo,
fireRate: stats.fireRate,
lastShot: 0,
color,
characterType: charType,
tempDamageBoost: false,
lean: 0,
consecutiveMoveTime: 0,
nextShotCritical: false,
shieldActive: false,
hitsTaken: 0,
shieldEndTime: 0,
frozen: false,
frozenEndTime: 0
};
}

// åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡
initGameObjects () {
try {
this.generateObstacles ();
this.specialEffects.innerHTML = '';
this.player1 = this.createPlayer (1, this.selectedP1Char);
this.player2 = this.createPlayer (2, this.selectedP2Char);
this.bullets = [];

// åˆå§‹åŒ–æŒ‰é”®çŠ¶æ€
this.keys = {
w: false, s: false, space: false, up: false, down: false, enter: false,
a: false, d: false, left: false, right: false, escape: false,
q: false, p: false
};

this.actions = {
shootP1: false,
shootP2: false,
shootSpecialP1: false,
shootSpecialP2: false
};

this.updateUI ();
} catch (e) {
console.error (' åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡å¤±è´¥:', e);
}
}

// å¼€å§‹æ¸¸æˆè®¡æ—¶å™¨
startGameTimer () {
this.gameTime = 0;
this.updateGameTimeDisplay ();

if (this.gameTimer) clearInterval(this.gameTimer);

this.gameTimer = setInterval(() => {
this.gameTime++;
this.updateGameTimeDisplay();

// æ ‡å‡†æ¨¡å¼ä¸‹ 10 åˆ†é’Ÿç»“æŸæ¸¸æˆ
if (this.selectedMode === 'standard' && this.gameTime>= 600) {
const winner = this.p1Wins > this.p2Wins ? 'p1' : (this.p1Wins === this.p2Wins ? (Math.random () > 0.5 ? 'p1' : 'p2') : 'p2');
this.endGame (winner, ' æ—¶é—´ç»“æŸ ');
}
}, 1000);
}

// æ›´æ–°æ¸¸æˆæ—¶é—´æ˜¾ç¤º
updateGameTimeDisplay () {
const minutes = Math.floor (this.gameTime/ 60).toString ().padStart (2, '0');
const seconds = (this.gameTime % 60).toString ().padStart (2, '0');
document.getElementById ('gameTime').textContent = ${minutes}:${seconds};
}

// å¤„ç†é”®ç›˜æŒ‰ä¸‹äº‹ä»¶
handleKeyDown (e) {
if (this.gameState !== 'playing') return;

// é˜»æ­¢é»˜è®¤è¡Œä¸º
const gameKeys = [' ', 'ArrowUp', 'ArrowDown', 'w', 's', 'Enter', 'Escape', 'a', 'd', 'ArrowLeft', 'ArrowRight', 'q', 'p'];
if (gameKeys.includes (e.key)) e.preventDefault ();

// è®¾ç½®æŒ‰é”®çŠ¶æ€
switch (e.key) {
case 'w': this.keys.w = true; break;
case's': this.keys.s = true; break;
case ' ': this.keys.space = true; this.actions.shootP1 = true; break;
case 'ArrowUp': this.keys.up = true; break;
case 'ArrowDown': this.keys.down = true; break;
case 'Enter': this.keys.enter = true; this.actions.shootP2 = true; break;
case 'a': this.keys.a = true; break;
case 'd': this.keys.d = true; break;
case 'ArrowLeft': this.keys.left = true; break;
case 'ArrowRight': this.keys.right = true; break;
case 'Escape': if (!this.keys.escape) { this.keys.escape = true; this.gameState === 'playing' ? this.pauseGame () : this.resumeGame (); } break;
case 'q': this.keys.q = true; this.actions.shootSpecialP1 = true; break;
case 'p': this.keys.p = true; this.actions.shootSpecialP2 = true; break;
}
}

// å¤„ç†é”®ç›˜é‡Šæ”¾äº‹ä»¶
handleKeyUp (e) {
const gameKeys = [' ', 'ArrowUp', 'ArrowDown', 'w', 's', 'Enter', 'Escape', 'a', 'd', 'ArrowLeft', 'ArrowRight', 'q', 'p'];
if (gameKeys.includes (e.key)) e.preventDefault ();

// é‡ç½®æŒ‰é”®çŠ¶æ€
switch (e.key) {
case 'w': this.keys.w = false; break;
case's': this.keys.s = false; break;
case ' ': this.keys.space = false; this.actions.shootP1 = false; break;
case 'ArrowUp': this.keys.up = false; break;
case 'ArrowDown': this.keys.down = false; break;
case 'Enter': this.keys.enter = false; this.actions.shootP2 = false; break;
case 'a': this.keys.a = false; break;
case 'd': this.keys.d = false; break;
case 'ArrowLeft': this.keys.left = false; break;
case 'ArrowRight': this.keys.right = false; break;
case 'Escape': this.keys.escape = false; break;
case 'q': this.keys.q = false; this.actions.shootSpecialP1 = false; break;
case 'p': this.keys.p = false; this.actions.shootSpecialP2 = false; break;
}
}

// å¤„ç†è‡ªåŠ¨è£…å¡«å­å¼¹
handleAutoReload () {
const now = Date.now ();

// æ¯ 5 ç§’è‡ªåŠ¨è£…å¡«å­å¼¹
if (now - this.lastReloadTime> 5000) {
this.lastReloadTime = now;

if (this.player1.ammo < this.player1.maxAmmo) {
this.player1.ammo++;
this.updateUI();
}

if (this.player2.ammo < this.player2.maxAmmo) {
this.player2.ammo++;
this.updateUI();
}
}
}

// å¤„ç†ç©å®¶è¾“å…¥
handleInput () {
if (!this.player1 || !this.player2) return;

const now = Date.now();

// æ£€æŸ¥å†°å†»çŠ¶æ€
if (this.player1.frozen && now> this.player1.frozenEndTime) {
this.player1.frozen = false;
this.player1.speed = this.player1.baseSpeed;
this.showPowerupIndicator ('p1', ' å†°å†»æ•ˆæœç»“æŸ ');
}

if (this.player2.frozen && now> this.player2.frozenEndTime) {
this.player2.frozen = false;
this.player2.speed = this.player2.baseSpeed;
this.showPowerupIndicator ('p2', ' å†°å†»æ•ˆæœç»“æŸ ');
}

// ç©å®¶ 1 ç§»åŠ¨
if (!this.player1.frozen) {
if (this.keys.w && this.player1.y > 0) this.player1.y = Math.max (0, this.player1.y - this.player1.speed);
if (this.keys.s && this.player1.y + this.player1.height < this.canvas.height) this.player1.y = Math.min (this.canvas.height - this.player1.height, this.player1.y + this.player1.speed);
}

// ç©å®¶ 2 ç§»åŠ¨
if (!this.player2.frozen) {
if (this.keys.up && this.player2.y > 0) this.player2.y = Math.max (0, this.player2.y - this.player2.speed);
if (this.keys.down && this.player2.y + this.player2.height < this.canvas.height) this.player2.y = Math.min (this.canvas.height - this.player2.height, this.player2.y + this.player2.speed);
}

// ç©å®¶ 1 å€¾æ–œ
let lean1 = 0;
if (this.keys.a) lean1 = -1;
else if (this.keys.d) lean1 = 1;
this.player1.lean = lean1;

// ç©å®¶ 2 å€¾æ–œ
let lean2 = 0;
if (this.keys.left) lean2 = 1;
else if (this.keys.right) lean2 = -1;
this.player2.lean = lean2;

// å°„å‡»å¤„ç†
const currentTime = Date.now ();

if (this.actions.shootP1 && this.player1.ammo > 0 && currentTime - this.player1.lastShot > this.player1.fireRate) {
this.shoot('p1', lean1, false);
this.player1.lastShot = currentTime;
this.actions.shootP1 = false;
}

if (this.actions.shootP2 && this.player2.ammo > 0 && currentTime - this.player2.lastShot > this.player2.fireRate) {
this.shoot('p2', lean2, false);
this.player2.lastShot = currentTime;
this.actions.shootP2 = false;
}

if (this.actions.shootSpecialP1 && this.player1.specialAmmo > 0 && currentTime - this.player1.lastShot > this.player1.fireRate) {
this.shoot('p1', lean1, true);
this.player1.lastShot = currentTime;
this.actions.shootSpecialP1 = false;
}

if (this.actions.shootSpecialP2 && this.player2.specialAmmo > 0 && currentTime - this.player2.lastShot > this.player2.fireRate) {
this.shoot('p2', lean2, true);
this.player2.lastShot = currentTime;
this.actions.shootSpecialP2 = false;
}

// å¤„ç†è‡ªåŠ¨è£…å¡«
this.handleAutoReload ();
}

// å°„å‡»æ–¹æ³•
shoot (player, lean = 0, isSpecial = false) {
const p = player === 'p1' ? this.player1 : this.player2;

// åˆ›å»ºå­å¼¹å¯¹è±¡
const bullet = {
x: player === 'p1' ? p.x + p.width : p.x,
y: p.y + p.height/ 2,
width: 10,
height: 4,
speed: player === 'p1' ? 8 : -8,
verticalSpeed: (player === 'p1' ? 1 : -1) * lean * 2.8,
color: p.color,
owner: player,
isSpecial,
isDamageBoosted: p.tempDamageBoost,
isCritical: p.nextShotCritical,
bulletType: 'normal',
pierceCount: 0,
bounceCount: 0,
explosionRadius: 0
};

// å¤„ç†æš´å‡»
if (p.nextShotCritical) {
p.nextShotCritical = false;
p.consecutiveMoveTime = 0;
this.showCriticalIndicator (bullet.x, bullet.y);
}

// æ·»åŠ å­å¼¹åˆ°æ•°ç»„
this.bullets.push (bullet);

// æ’­æ”¾å°„å‡»éŸ³æ•ˆ
playSE (player === 'p1' ? 'sndShootP1' : 'sndShootP2');

// å‡å°‘å¼¹è¯
if (isSpecial) p.specialAmmo--;
else p.ammo--;

this.updateUI();
}

// æ£€æŸ¥éšœç¢ç‰©ç¢°æ’
checkObstacleCollisions (bullet) {
for (let i = this.obstacles.length - 1; i >= 0; i--) {
const ob = this.obstacles [i];

// è®¡ç®—æ—‹è½¬åçš„åæ ‡
const cos = Math.cos (ob.angle);
const sin = Math.sin (ob.angle);
const dx = bullet.x - (ob.x + ob.width/ 2);
const dy = bullet.y - (ob.y + ob.height/ 2);
const rx = dx * cos + dy * sin;
const ry = -dx * sin + dy * cos;
const halfW = ob.width/ 2;
const halfH = ob.height/ 2;

// æ£€æŸ¥æ˜¯å¦ç¢°æ’
if (Math.abs (rx) < halfW && Math.abs (ry) < halfH) {
switch (ob.type) {
case 'bounce':
case 'pierce':
case 'explosive':
case 'freeze':
const player = bullet.owner === 'p1' ? this.player1 : this.player2;
const isP1 = bullet.owner === 'p1';
const maxSpecialAmmo = 3;
const gainedAmmo = Math.min (3, maxSpecialAmmo - player.specialAmmo);
const currentAmmo = player.specialAmmo;
const newAmmo = Math.min (3, currentAmmo + gainedAmmo);
const actualGained = newAmmo - currentAmmo;

if (isP1) {
this.player1SkillType = ob.type;
player.specialAmmo = newAmmo;
} else {
this.player2SkillType = ob.type;
player.specialAmmo = newAmmo;
}

if (actualGained > 0) {
this.showPowerupIndicator(bullet.owner, è·å¾—${actualGained}å‘${ob.type}æŠ€èƒ½å­å¼¹!);
} else {
this.showPowerupIndicator(bullet.owner, æŠ€èƒ½å­å¼¹å·²æ»¡!);
}
break;
case 'strong':
ob.health--;
if (ob.health <= 0) {
this.obstacles.splice(i, 1);
this.handleObstacleReward(bullet.owner);
}
break;
case 'reflect':
this.applyNormalReflection(bullet, ob);
return false;
}

// æˆ˜æœ¯ä¸“å®¶ç©¿é€èƒ½åŠ›
if (bullet.owner === 'p1' && this.player1.characterType === 'tactical' && bullet.pierceCount <= 0) {
bullet.pierceCount = 1;
return false;
} else if (bullet.owner === 'p2' && this.player2.characterType === 'tactical' && bullet.pierceCount <= 0) {
bullet.pierceCount = 1;
return false;
}

// å¤„ç†å­å¼¹ç¢°æ’
if (ob.type !== 'reflect' && !(bullet.bulletType === 'pierce' && bullet.pierceCount> 0)) {
if (ob.type !== 'strong' || ob.health <= 0) {
this.obstacles.splice (i, 1);
this.handleObstacleReward (bullet.owner);
}
return true;
}
}
}

return false;
}

// å¤„ç†éšœç¢ç‰©å¥–åŠ±
handleObstacleReward (owner) {
const p = owner === 'p1' ? this.player1 : this.player2;

// æˆ˜æœ¯ä¸“å®¶å‡»ç ´éšœç¢ç‰©æœ‰å‡ ç‡è·å¾—å¥–åŠ±
if (p.characterType === 'tactical') {
if (Math.random () < 0.5) {
if (p.ammo < p.maxAmmo) {
p.ammo++;
this.showPowerupIndicator (owner, '+1 å­å¼¹ ');
} else {
p.specialAmmo++;
this.showPowerupIndicator (owner, '+1 æŠ€èƒ½å­å¼¹ ');
}
} else {
p.specialAmmo++;
this.showPowerupIndicator (owner, '+1 æŠ€èƒ½å­å¼¹ ');
}

this.updateUI();
}
}

// åº”ç”¨æ™®é€šåå°„
applyNormalReflection (bullet, ob) {
// æŒ¡æ¿æ³•çº¿ï¼ˆå•ä½å‘é‡ï¼‰
const normalAngle = ob.angle + Math.PI/ 2;
const nx = Math.cos (normalAngle);
const ny = Math.sin (normalAngle);

// å­å¼¹å…¥å°„é€Ÿåº¦å‘é‡ï¼ˆå•ä½åŒ–ï¼‰
const vx = bullet.speed;
const vy = bullet.verticalSpeed || 0;
const mag = Math.sqrt (vx * vx + vy * vy);
const vxUnit = vx /mag;
const vyUnit = vy /mag;

// è®¡ç®—åå°„åçš„é€Ÿåº¦å‘é‡
const dot = vxUnit * nx + vyUnit * ny;
const rx = vxUnit - 2 * dot * nx;
const ry = vyUnit - 2 * dot * ny;

// é‡æ–°è®¾ç½®å­å¼¹é€Ÿåº¦
bullet.speed = rx * mag;
bullet.verticalSpeed = ry * mag;

this.showBulletEffect(bullet.x, bullet.y, 'reflection');
}

// æ˜¾ç¤ºå­å¼¹ç‰¹æ•ˆ
showBulletEffect (x, y, type) {
const effect = this.getBulletEffect ();
effect.style.left = ${x}px;
effect.style.top = ${y}px;
effect.style.width = '15px';
effect.style.height = '15px';
effect.style.borderRadius = '50%';

// æ ¹æ®ç±»å‹è®¾ç½®ç‰¹æ•ˆæ ·å¼
switch (type) {
case 'reflection':
effect.style.backgroundColor = 'rgba (96, 125, 139, 0.6)';
effect.style.boxShadow = '0 0 10px 3px rgba (96, 125, 139, 0.8)';
break;
case 'explosion':
effect.style.backgroundColor = 'rgba (255, 152, 0, 0.6)';
effect.style.boxShadow = '0 0 15px 5px rgba (255, 152, 0, 0.8)';
effect.style.width = '60px';
effect.style.height = '60px';
effect.style.transform = 'translate (-25%, -25%)';
break;
case 'freeze':
effect.style.backgroundColor = 'rgba (139, 195, 74, 0.6)';
effect.style.boxShadow = '0 0 15px 5px rgba (139, 195, 74, 0.8)';
effect.style.width = '30px';
effect.style.height = '30px';
effect.style.transform = 'translate (-25%, -25%)';
break;
}

effect.style.display = 'block';
effect.style.opacity = '1';
effect.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

setTimeout(() => {
effect.style.opacity = '0';

if (type === 'explosion') {
effect.style.transform = 'translate(-25%, -25%) scale(1.5)';
} else if (type === 'freeze') {
effect.style.transform = 'translate(-25%, -25%) scale(1.5)';
} else {
effect.style.transform = 'scale(1.5)';
}

setTimeout(() => {
effect.style.display = 'none';
}, 500);
}, 10);
}

// æ˜¾ç¤ºèƒ½é‡æå‡æŒ‡ç¤ºå™¨
showPowerupIndicator (player, text) {
const indicator = this.getPowerupIndicator ();
indicator.textContent = text;
indicator.className = powerup-indicator ${player === 'p1' ? 'text-player1' : 'text-player2'};

const playerObj = player === 'p1' ? this.player1 : this.player2;
indicator.style.left = ${player === 'p1' ? playerObj.x + playerObj.width + 10 : playerObj.x - 80}px;
indicator.style.top = ${playerObj.y}px;
indicator.style.display = 'block';
indicator.style.opacity = '0';
indicator.style.transform = 'translateY(0)';

setTimeout(() => {
indicator.style.opacity = '1';
indicator.style.transform = 'translateY(-10px)';
}, 10);

setTimeout(() => {
indicator.style.opacity = '0';
indicator.style.transform = 'translateY(-20px)';

setTimeout(() => {
indicator.style.display = 'none';
}, 500);
}, 2000);
}

// æ˜¾ç¤ºæŠ¤ç›¾ç‰¹æ•ˆ
showShieldEffect (player, x, y, width, height) {
this.removeShieldEffect (player);

const shield = document.createElement('div');
shield.className = 'shield-effect';
shield.dataset.player = player;
shield.style.width = ${width * 2}px;
shield.style.height = ${height * 1.5}px;
shield.style.left = ${x - width/2}px;
shield.style.top = ${y - height/4}px;

this.specialEffects.appendChild(shield);
}

// ç§»é™¤æŠ¤ç›¾ç‰¹æ•ˆ
removeShieldEffect (player) {
const existingShield = this.specialEffects.querySelector (.shield-effect[data-player="${player}"]);
if (existingShield) existingShield.remove();
}

// æ˜¾ç¤ºæš´å‡»æŒ‡ç¤ºå™¨
showCriticalIndicator (x, y) {
const indicator = this.getCriticalIndicator ();
indicator.textContent = ' æš´å‡»ï¼';
indicator.style.left = ${x}px;
indicator.style.top = ${y - 20}px;
indicator.style.display = 'block';
indicator.style.opacity = '0';

setTimeout(() => {
indicator.style.opacity = '1';
indicator.style.transform = 'translateY(-10px)';
}, 10);

setTimeout(() => {
indicator.style.opacity = '0';
indicator.style.transform = 'translateY(-20px)';

setTimeout(() => {
indicator.style.display = 'none';
}, 500);
}, 1000);
}

// æ£€æŸ¥ç¢°æ’
checkCollision (obj1, obj2) {
return obj1.x < obj2.x + obj2.width && obj1.x + obj1.width > obj2.x &&
obj1.y < obj2.y + obj2.height && obj1.y + obj1.height > obj2.y;
}

// æ›´æ–°å­å¼¹çŠ¶æ€
updateBullets () {
this.manageObstacles ();
const bulletsToRemove = [];

for (let i = 0; i < this.bullets.length; i++) {
const b = this.bullets[i];

// æ›´æ–°å­å¼¹ä½ç½®
b.x += b.speed;
b.y += b.verticalSpeed || 0;

let shouldRemove = false;

// æ£€æŸ¥è¾¹ç•Œç¢°æ’
if (b.x < 0 || b.x> this.canvas.width || b.y < 0 || b.y > this.canvas.height) {
if (b.bulletType === 'bounce' && b.bounceCount > 0) {
// å¼¹è·³å­å¼¹å¤„ç†
b.bounceCount--;
if (b.x < 0 || b.x > this.canvas.width) b.speed = -b.speed;
if (b.y < 0 || b.y > this.canvas.height) b.verticalSpeed = -b.verticalSpeed;
b.x = Math.max (0, Math.min (this.canvas.width, b.x));
b.y = Math.max (0, Math.min (this.canvas.height, b.y));
} else {
shouldRemove = true;
}
}

if (shouldRemove) {
bulletsToRemove.push(i);
continue;
}

// æ£€æŸ¥éšœç¢ç‰©ç¢°æ’
const hitObstacle = this.checkObstacleCollisions (b);
if (hitObstacle) {
bulletsToRemove.push (i);
continue;
}

// æ£€æŸ¥ç©å®¶ç¢°æ’
if (this.player1 && this.player2) {
const target = b.owner === 'p1' ? this.player2 : this.player1;

if (this.checkCollision (b, target)) {
// ç‰¹æ®Šå­å¼¹æ•ˆæœ
if (b.bulletType === 'explosive') {
this.showBulletEffect (b.x, b.y, 'explosion');
this.applyExplosionDamage (b.owner, b.x, b.y, b.explosionRadius);
} else if (b.bulletType === 'freeze') {
this.showBulletEffect (b.x, b.y, 'freeze');
this.applyFreezeEffect (target, b.owner);
}

// è®¡ç®—ä¼¤å®³
let damage = 1;
if ((b.owner === 'p1' ? this.player1 : this.player2).characterType === 'heavy') damage += 1;
if (b.isDamageBoosted) damage += 1;
if (b.isCritical) damage *= 1.5;

// æŠ¤ç›¾å¤„ç†
if (target.shieldActive) {
target.shieldActive = false;
this.removeShieldEffect (target === this.player1 ? 'p1' : 'p2');
this.showPowerupIndicator (target === this.player1 ? 'p1' : 'p2', ' æŠ¤ç›¾æŠµæŒ¡ä¼¤å®³ï¼');
bulletsToRemove.push (i);
continue;
}

// ç©¿é€å­å¼¹å¤„ç†
if (b.bulletType === 'pierce' && b.pierceCount> 0) {
b.pierceCount--;
} else {
// åº”ç”¨ä¼¤å®³
target.armor -= damage;
target.hitsTaken++;

// é‡ç”²å ¡å’æŠ€èƒ½è§¦å‘
if (target.characterType === 'heavy' && target.hitsTaken>= 3 && !target.shieldActive) {
this.handleHeavyAbility (target);
}

bulletsToRemove.push(i);

// æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
if (target.armor <= 0) {
if (b.owner === 'p1') this.p1Wins++; else this.p2Wins++;
this.checkRoundEnd (b.owner, ' å‡»ç ´æ‰€æœ‰æŠ¤ç”² ');
}
}
}
}
}

// ç§»é™¤éœ€è¦åˆ é™¤çš„å­å¼¹
for (let i = bulletsToRemove.length - 1; i>= 0; i--) {
this.bullets.splice (bulletsToRemove [i], 1);
}

this.updateUI();
}

// åº”ç”¨çˆ†ç‚¸ä¼¤å®³
applyExplosionDamage (owner, x, y, radius) {
const targets = [this.player1, this.player2];

targets.forEach(target => {
if (target && target !== (owner === 'p1' ? this.player1 : this.player2)) {
const dx = x - (target.x + target.width / 2);
const dy = y - (target.y + target.height / 2);
const distance = Math.sqrt(dx * dx + dy * dy);

if (distance < radius) {
// è·ç¦»è¶Šè¿‘ä¼¤å®³è¶Šé«˜
const damage = Math.max (1, Math.floor (3 * (1 - distance /radius)));
target.armor -= damage;
target.hitsTaken++;

// é‡ç”²å ¡å’æŠ€èƒ½è§¦å‘
if (target.characterType === 'heavy' && target.hitsTaken>= 3 && !target.shieldActive) {
this.handleHeavyAbility (target);
}

// æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
if (target.armor <= 0) {
if (owner === 'p1') this.p1Wins++; else this.p2Wins++;
this.checkRoundEnd (owner, ' çˆ†ç‚¸ä¼¤å®³å‡»ç ´æ‰€æœ‰æŠ¤ç”² ');
}
}
}
});
}

// åº”ç”¨å†°å†»æ•ˆæœ
applyFreezeEffect (target, attacker) {
target.frozen = true;
target.frozenEndTime = Date.now () + 3000;
target.speed = target.baseSpeed * 0.5;

this.showPowerupIndicator (attacker === 'p1' ? 'p1' : 'p2', ' å‡»ä¸­å¹¶å†°å†»æ•Œäººï¼');
this.showPowerupIndicator (target === this.player1 ? 'p1' : 'p2', ' è¢«å†°å†»å‡é€Ÿï¼');
}

// ç®¡ç†éšœç¢ç‰©
manageObstacles () {
const now = Date.now ();
const obstaclesToRemove = [];

for (let i = 0; i < this.obstacles.length; i++) {
const ob = this.obstacles[i];
const lifeLeft = ob.lifetime - (now - ob.spawnTime);

// æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»é™¤
if (lifeLeft <= 0) {
obstaclesToRemove.push (i);
continue;
}

// è®¾ç½®æ·¡å‡ºæ•ˆæœ
ob.isFading = lifeLeft < 2000;
ob.pulseTimer = (ob.pulseTimer || 0) + 0.1;
}

// ç§»é™¤è¿‡æœŸéšœç¢ç‰©
for (let i = obstaclesToRemove.length - 1; i>= 0; i--) {
this.obstacles.splice (obstaclesToRemove [i], 1);
}

// éšæœºæ·»åŠ æ–°éšœç¢ç‰©
if (Math.random () < 0.01 && this.obstacles.length < 10) this.addRandomObstacle ();
}

// æ·»åŠ éšæœºéšœç¢ç‰©
addRandomObstacle () {
const obstacleTypes = [
{type: 'reflect', color: '#607D8B', health: 1, weight: 50},
{ type: 'strong', color: '#795548', health: 2, weight: 30 },
{ type: 'bounce', color: '#9C27B0', health: 1, weight: 5 },
{ type: 'pierce', color: '#00BCD4', health: 1, weight: 5 },
{ type: 'explosive', color: '#FF9800', health: 1, weight: 5 },
{ type: 'freeze', color: '#8BC34A', health: 1, weight: 5 }
];

// åŠ æƒéšæœºé€‰æ‹©
function weightedRandom (types) {
const totalWeight = types.reduce ((sum, t) => sum + t.weight, 0);
let rand = Math.random () * totalWeight;

for (const t of types) {
if (rand < t.weight)
return t;
rand -= t.weight;
}

return types[0];
}

// æ£€æŸ¥é‡å 
function isOverlapping (newObstacle, existingObstacles) {
const margin = 10;
return existingObstacles.some (ob =>
newObstacle.x < ob.x + ob.width + margin &&
newObstacle.x + newObstacle.width + margin > ob.x &&
newObstacle.y < ob.y + ob.height + margin &&
newObstacle.y + newObstacle.height + margin > ob.y
);
}

const centerX = this.canvas.width / 2;
const centerY = this.canvas.height / 2;
const spawnAreaWidth = this.canvas.width * 0.6;
const spawnAreaHeight = this.canvas.height * 0.6;

let attempts = 0;
let placed = false;

// å°è¯•æ”¾ç½®éšœç¢ç‰©
while (!placed && attempts < 50) {
const type = weightedRandom (obstacleTypes);
const width = 12;
const height = 100;
const x = centerX - spawnAreaWidth / 2 + Math.random () * (spawnAreaWidth - width);
const y = centerY - spawnAreaHeight / 2 + Math.random () * (spawnAreaHeight - height);
const angle = (Math.random () * 60 - 30) * Math.PI/ 180;
const lifetime = 8000 + Math.random () * 10000;

const newObstacle = { x, y, width, height };

// æ£€æŸ¥ä½ç½®æ˜¯å¦æœ‰æ•ˆ
if (x> 0 && x + width < this.canvas.width && y > 0 && y + height < this.canvas.height && !isOverlapping (newObstacle, this.obstacles)) {
this.obstacles.push ({
x, y, width, height,
color: type.color,
health: type.health,
type: type.type,
angle,
spawnTime: Date.now (),
lifetime,
isFading: false,
pulseTimer: 0
});

placed = true;
}

attempts++;
}
}

// å¤„ç†é—ªç”µå…ˆé”‹æŠ€èƒ½
handleLightningAbility (p, isMoving, deltaTime) {
if (isMoving) {
p.consecutiveMoveTime += deltaTime;

// è¿ç»­ç§»åŠ¨ 3 ç§’åè§¦å‘æš´å‡»
if (p.consecutiveMoveTime>= 3000 && !p.nextShotCritical) {
p.nextShotCritical = true;
this.showPowerupIndicator (p === this.player1 ? 'p1' : 'p2', ' æš´å‡»å‡†å¤‡å°±ç»ªï¼');
}
} else {
// åœæ­¢ç§»åŠ¨åå‡å°‘è¿ç»­ç§»åŠ¨æ—¶é—´
p.consecutiveMoveTime = Math.max (0, p.consecutiveMoveTime - deltaTime * 1.5);

if (p.consecutiveMoveTime < 2000) {
p.nextShotCritical = false;
}
}
}

// å¤„ç†é‡ç”²å ¡å’æŠ€èƒ½
handleHeavyAbility (p) {
// æ£€æŸ¥æŠ¤ç›¾æ˜¯å¦åˆ°æœŸ
if (p.shieldActive && Date.now () > p.shieldEndTime) {
p.shieldActive = false;
this.removeShieldEffect (p === this.player1 ? 'p1' : 'p2');
this.showPowerupIndicator (p === this.player1 ? 'p1' : 'p2', ' æŠ¤ç›¾æ¶ˆå¤± ');
}

// å—åˆ° 3 æ¬¡æ”»å‡»åæ¿€æ´»æŠ¤ç›¾
if (p.hitsTaken>= 3 && !p.shieldActive) {
p.shieldActive = true;
p.shieldEndTime = Date.now () + 5000;
p.hitsTaken = 0;

this.showShieldEffect (p === this.player1 ? 'p1' : 'p2', p.x, p.y, p.width, p.height);
this.showPowerupIndicator (p === this.player1 ? 'p1' : 'p2', ' æŠ¤ç›¾æ¿€æ´» (5 ç§’)!');
}
}

// å¤„ç†ç‰¹æ®ŠæŠ€èƒ½
handleSpecialAbilities (deltaTime) {
[this.player1, this.player2].forEach (p => {
if (p.characterType === 'lightning') {
const isMoving = (p === this.player1 && (this.keys.w || this.keys.s)) ||
(p === this.player2 && (this.keys.up || this.keys.down));
this.handleLightningAbility (p, isMoving, deltaTime);
} else if (p.characterType === 'heavy') {
this.handleHeavyAbility (p);
}
});
}

// ç»˜åˆ¶ç½‘æ ¼
drawGrid () {
this.ctx.save ();
this.ctx.strokeStyle = 'rgba (255,255,255,0.05)';
this.ctx.lineWidth = 1;

// ç»˜åˆ¶æ°´å¹³çº¿
for (let y = 0; y < this.canvas.height; y += 30) {
this.ctx.beginPath ();
this.ctx.moveTo (0, y);
this.ctx.lineTo (this.canvas.width, y);
this.ctx.stroke ();
}

// ç»˜åˆ¶å‚ç›´çº¿
for (let x = 0; x < this.canvas.width; x += 30) {
this.ctx.beginPath ();
this.ctx.moveTo (x, 0);
this.ctx.lineTo (x, this.canvas.height);
this.ctx.stroke ();
}

// ç»˜åˆ¶ä¸­å¤®åˆ†éš”çº¿
this.ctx.strokeStyle = 'rgba (108,92,231,0.3)';
this.ctx.lineWidth = 2;
this.ctx.setLineDash ([10, 10]);
this.ctx.beginPath ();
this.ctx.moveTo (this.canvas.width/ 2, 0);
this.ctx.lineTo (this.canvas.width/ 2, this.canvas.height);
this.ctx.stroke ();

this.ctx.restore();
}

// ç»˜åˆ¶éšœç¢ç‰©
drawObstacles () {
if (!this.obstacles.length) return;

this.ctx.save();

this.obstacles.forEach(o => {
this.ctx.save();
this.ctx.translate(o.x + o.width / 2, o.y + o.height / 2);
this.ctx.rotate(o.angle);

// è®¡ç®—é€æ˜åº¦
const alpha = o.type === 'strong' && o.health < 2 ? 0.5 : 1;

// å åŠ æ·¡å‡ºæ•ˆæœ
let finalAlpha = alpha;
if (o.isFading) {
finalAlpha *= Math.sin ((o.lifetime - (Date.now () - o.spawnTime)) /o.lifetime * Math.PI/ 2);
}

// ç‰¹æ®Šéšœç¢ç‰©å‘å…‰æ•ˆæœ
if (['bounce', 'pierce', 'explosive', 'freeze'].includes (o.type)) {
const pulse = 0.7 + Math.sin (o.pulseTimer) * 0.3;
this.ctx.shadowColor = o.color;
this.ctx.shadowBlur = 15 * pulse;
}

this.ctx.fillStyle = rgba(${this.hexToRgb(o.color)}, ${finalAlpha});
this.ctx.fillRect(-o.width / 2, -o.height / 2, o.width, o.height);
this.ctx.restore();
});

this.ctx.restore();
}

// åå…­è¿›åˆ¶é¢œè‰²è½¬ RGB
hexToRgb (hex) {
hex = hex.replace ('#', '');
const r = parseInt (hex.substring (0, 2), 16);
const g = parseInt (hex.substring (2, 4), 16);
const b = parseInt (hex.substring (4, 6), 16);
return ${r}, ${g}, ${b};
}

// ç»˜åˆ¶ç©å®¶
drawPlayers () {
if (!this.player1 || !this.player2) return;

[this.player1, this.player2].forEach(p => {
this.ctx.save();
this.ctx.translate(p.x + p.width / 2, p.y + p.height / 2);
this.ctx.rotate(p.lean * 0.15);

// é€Ÿåº¦æå‡æ•ˆæœ
if (p.speed> p.baseSpeed) {
this.ctx.shadowColor = '#2979FF';
this.ctx.shadowBlur = 10;
}

// ä¼¤å®³æå‡æ•ˆæœ
if (p.tempDamageBoost) {
this.ctx.shadowColor = '#D50000';
this.ctx.shadowBlur = 10;
}

// æš´å‡»å‡†å¤‡æ•ˆæœ
if (p.nextShotCritical) {
this.ctx.shadowColor = '#FFD700';
this.ctx.shadowBlur = 15;
}

// å†°å†»æ•ˆæœ
if (p.frozen) {
this.ctx.shadowColor = '#8BC34A';
this.ctx.shadowBlur = 10;
}

this.ctx.fillStyle = p.color;
this.ctx.fillRect(-p.width / 2, -p.height / 2, p.width, p.height);
this.ctx.restore();
});
}

// ç»˜åˆ¶ç„å‡†è¾…åŠ©çº¿
drawAimAssistLines () {
if (!this.player1 || !this.player2) return;

// ç©å®¶ 1 ç„å‡†çº¿
this.ctx.save ();
this.ctx.strokeStyle = 'rgba (9, 132, 227, 0.6)';
this.ctx.lineWidth = 2;
this.ctx.beginPath ();
const p1EndX = this.player1.x + this.player1.width + 50;
const p1EndY = this.player1.y + this.player1.height/ 2 + this.player1.lean * 15;
this.ctx.moveTo (this.player1.x + this.player1.width, this.player1.y + this.player1.height/ 2);
this.ctx.lineTo (p1EndX, p1EndY);
this.ctx.stroke ();
this.ctx.restore ();

// ç©å®¶ 2 ç„å‡†çº¿
this.ctx.save ();
this.ctx.strokeStyle = 'rgba (231, 76, 60, 0.6)';
this.ctx.lineWidth = 2;
this.ctx.beginPath ();
const p2EndX = this.player2.x - 50;
const p2EndY = this.player2.y + this.player2.height/ 2 - this.player2.lean * 15;
this.ctx.moveTo (this.player2.x, this.player2.y + this.player2.height/ 2);
this.ctx.lineTo (p2EndX, p2EndY);
this.ctx.stroke ();
this.ctx.restore ();
}

// ç»˜åˆ¶å­å¼¹
drawBullets () {
if (!this.bullets.length) return;

this.ctx.save();

this.bullets.forEach(b => {
this.ctx.save();

// æ ¹æ®å­å¼¹ç±»å‹è®¾ç½®æ ·å¼
switch (b.bulletType) {
case 'bounce':
this.ctx.fillStyle = '#9C27B0';
this.ctx.shadowColor = '#9C27B0';
this.ctx.shadowBlur = 5;
this.ctx.beginPath ();
this.ctx.arc (b.x + b.width/ 2, b.y + b.height/ 2, b.width/ 1.2, 0, Math.PI * 2);
this.ctx.fill ();
break;
case 'pierce':
this.ctx.fillStyle = '#00BCD4';
this.ctx.shadowColor = '#00BCD4';
this.ctx.shadowBlur = 5;
this.ctx.fillRect (b.x - 1, b.y, b.width + 2, b.height);
break;
case 'explosive':
this.ctx.fillStyle = '#FF9800';
this.ctx.shadowColor = '#FF9800';
this.ctx.shadowBlur = 7;
this.ctx.beginPath ();
this.ctx.arc (b.x + b.width/ 2, b.y + b.height/ 2, b.width, 0, Math.PI * 2);
this.ctx.fill ();
break;
case 'freeze':
this.ctx.fillStyle = '#8BC34A';
this.ctx.shadowColor = '#8BC34A';
this.ctx.shadowBlur = 5;
this.ctx.fillRect (b.x, b.y, b.width, b.height);
break;
default:
if (b.isCritical) {
// æš´å‡»å­å¼¹
this.ctx.fillStyle = '#FFD700';
this.ctx.shadowColor = '#FFD700';
this.ctx.shadowBlur = 8;
this.ctx.beginPath ();
this.ctx.arc (b.x + b.width/ 2, b.y + b.height/ 2, b.width/ 1.5, 0, Math.PI * 2);
this.ctx.fill ();
} else if (b.isSpecial) {
// ç‰¹æ®Šå­å¼¹
this.ctx.fillStyle = '#FFD700';
this.ctx.beginPath ();
this.ctx.arc (b.x + b.width/ 2, b.y + b.height/ 2, b.width/ 2, 0, Math.PI * 2);
this.ctx.fill ();
} else if (b.isDamageBoosted) {
// ä¼¤å®³æå‡å­å¼¹
this.ctx.fillStyle = '#D50000';
this.ctx.fillRect (b.x, b.y, b.width, b.height);
} else {
// æ™®é€šå­å¼¹
this.ctx.fillStyle = b.color;
this.ctx.fillRect (b.x, b.y, b.width, b.height);
}
}

this.ctx.restore();
});

this.ctx.restore();
}

// ç»˜åˆ¶æ¸¸æˆåœºæ™¯
draw () {
this.ctx.clearRect (0, 0, this.canvas.width, this.canvas.height);
this.drawGrid ();
this.drawObstacles ();
this.drawPlayers ();
this.drawAimAssistLines ();
this.drawBullets ();
}

// æ¸¸æˆä¸»å¾ªç¯
gameLoop (timestamp) {
if (this.gameState !== 'playing') return;

if (!this.lastTime) this.lastTime = timestamp;
this.deltaTime = timestamp - this.lastTime;
this.lastTime = timestamp;

this.handleInput();
this.handleSpecialAbilities(this.deltaTime);
this.updateBullets();
this.draw();

requestAnimationFrame((ts) => this.gameLoop(ts));
}

// æ£€æŸ¥å›åˆç»“æŸ
checkRoundEnd (winner, reason) {
clearInterval (this.gameTimer);
this.gameState = 'roundEnd';
document.getElementById ('gamePhase').textContent = ' å›åˆç»“æŸ ';

this.roundWinnerText.textContent = winner === 'p1' ? ' ç©å®¶ 1 èµ¢å¾—æœ¬å±€ï¼' : ' ç©å®¶ 2 èµ¢å¾—æœ¬å±€ï¼';
this.roundResult.classList.remove ('hidden');

document.getElementById('p1Wins').textContent = this.p1Wins;
document.getElementById('p2Wins').textContent = this.p2Wins;

// å›åˆåˆ¶æ¨¡å¼å¤„ç†
if (this.selectedMode === 'rounds') {
if (this.p1Wins >= 2 || this.p2Wins >= 2) {
// æ¸¸æˆç»“æŸ
setTimeout (() => {
this.roundResult.classList.add ('hidden');
this.endGame (winner, reason);
}, 2000);
} else {
// ä¸‹ä¸€å›åˆå€’è®¡æ—¶
let countdown = 3;
this.nextRoundText.textContent = ä¸‹ä¸€å›åˆå°†åœ¨ ${countdown} ç§’åå¼€å§‹...;

const cd = setInterval(() => {
countdown--;
this.nextRoundText.textContent = ä¸‹ä¸€å›åˆå°†åœ¨ ${countdown} ç§’åå¼€å§‹...;

if (countdown <= 0) {
clearInterval (cd);
this.roundResult.classList.add ('hidden');
this.round++;
this.resetRound ();
}
}, 1000);
}
} else {
// æ ‡å‡†æ¨¡å¼ç›´æ¥ç»“æŸæ¸¸æˆ
setTimeout (() => {
this.roundResult.classList.add ('hidden');
this.endGame (winner, reason);
}, 2000);
}
}

// é‡ç½®å›åˆ
resetRound () {
document.getElementById ('roundNumber').textContent = ${this.round}/${this.maxRounds};
this.initGameObjects ();
this.showRoundTransition ();
this.gameTime = 0;
this.updateGameTimeDisplay ();
this.gameState = 'playing';
document.getElementById ('gamePhase').textContent = ' æ¸¸æˆè¿›è¡Œä¸­ ';
this.startGameTimer ();
this.lastTime = performance.now ();
this.lastReloadTime = Date.now ();
this.gameLoop ();
}

// ç»“æŸæ¸¸æˆ
endGame (winner, reason) {
playSE ('sndGameOver');
this.gameState = 'gameOver';
this.recordGameResult (winner, reason);

document.getElementById ('winnerText').textContent = winner === 'p1' ? ' ç©å®¶ 1 èƒœåˆ©ï¼' : ' ç©å®¶ 2 èƒœåˆ©ï¼';
document.getElementById ('winReason').textContent = reason;

this.gameOverMenu.classList.remove ('hidden');
document.getElementById ('gamePhase').textContent = ' æ¸¸æˆç»“æŸ ';
}

// æš‚åœæ¸¸æˆ
pauseGame () {
if (this.gameState === 'playing') {
this.gameState = 'paused';
clearInterval (this.gameTimer);
this.pauseMenu.classList.remove ('hidden');
document.getElementById ('gamePhase').textContent = ' å·²æš‚åœ ';
}
}

// ç»§ç»­æ¸¸æˆ
resumeGame () {
if (this.gameState === 'paused') {
this.gameState = 'playing';
this.pauseMenu.classList.add ('hidden');
this.startGameTimer ();
document.getElementById ('gamePhase').textContent = ' æ¸¸æˆè¿›è¡Œä¸­ ';
this.lastTime = performance.now ();
this.gameLoop ();
}
}

// é‡ç½®æ¸¸æˆ
resetGame () {
this.pauseMenu.classList.add ('hidden');
this.gameOverMenu.classList.add ('hidden');
this.roundResult.classList.add ('hidden');
this.statsPanel.classList.add ('hidden');

// é‡ç½®ç‰¹æ•ˆæŒ‡ç¤ºå™¨
this.powerupIndicatorPool.forEach (indicator => { indicator.style.display = 'none'; });
this.criticalIndicatorPool.forEach (indicator => { indicator.style.display = 'none'; });
this.bulletEffectPool.forEach (effect => { effect.style.display = 'none'; });

this.gameOverlay.classList.remove('hidden');
this.gameState = 'preparing';
this.round = 1;
this.maxRounds = this.selectedMode === 'rounds' ? 3 : 1;
this.p1Wins = 0;
this.p2Wins = 0;

if (this.gameTimer) clearInterval(this.gameTimer);

this.obstacles = [];
this.bullets = [];
this.player1 = null;
this.player2 = null;

document.getElementById ('gamePhase').textContent = ' å‡†å¤‡é˜¶æ®µ ';
document.getElementById ('roundNumber').textContent = ${this.round}/${this.maxRounds};
document.getElementById('p1Wins').textContent = this.p1Wins;
document.getElementById('p2Wins').textContent = this.p2Wins;

this.updateGameTimeDisplay();
}

// é€€å‡ºæ¸¸æˆ
quitGame () {
this.resetGame ();
}

// æ›´æ–° UI
updateUI () {
if (!this.player1 || !this.player2) return;

['p1', 'p2'].forEach((pl) => {
const p = pl === 'p1' ? this.player1 : this.player2;
const armorEl = document.getElementById(${pl}Armor);

// æ›´æ–°æŠ¤ç”²æ˜¾ç¤º
armorEl.innerHTML = '';
for (let i = 0; i < p.maxArmor; i++) {
const dot = document.createElement ('div');
dot.className = w-4 h-4 rounded-full ${i < p.armor ? (pl === 'p1' ? 'bg-player1' : 'bg-player2') : 'bg-gray-600 opacity-50'};
armorEl.appendChild(dot);
}

// æ›´æ–°å¼¹è¯æ˜¾ç¤º
document.getElementById (${pl}Ammo).textContent = ${p.ammo}/${p.maxAmmo};
document.getElementById(${pl}SpecialAmmo).textContent = p.specialAmmo;
});
}
}

// å®ŒæˆåŠ è½½
function completeLoading () {
playSE ('sndLoading');
const loader = document.getElementById ('loader');
const gameContainer = document.getElementById ('gameContainer');

loader.classList.add('fade-out');

setTimeout(() => {
loader.style.display = 'none';
gameContainer.classList.remove('hidden');
new PaddleShooter();
}, 500);
}

window.addEventListener('load', completeLoading);
</script>

</body>
</html>